<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Leoni Admin Dashboard</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f7fa;
        min-height: 100vh;
      }

      .dashboard-container {
        display: flex;
        min-height: 100vh;
      }

      .sidebar {
        width: 250px;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        padding: 20px;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
      }

      .sidebar-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .sidebar-header h2 {
        font-size: 24px;
        margin-bottom: 5px;
      }

      .sidebar-header p {
        font-size: 14px;
        opacity: 0.8;
      }

      .nav-menu {
        list-style: none;
      }

      .nav-menu li {
        margin-bottom: 10px;
      }

      .nav-menu a {
        color: white;
        text-decoration: none;
        display: flex;
        align-items: center;
        padding: 12px 15px;
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .nav-menu a:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateX(5px);
      }

      .nav-menu a.active {
        background: rgba(255, 255, 255, 0.2);
      }

      .nav-menu i {
        margin-right: 10px;
        width: 20px;
      }

      .main-content {
        flex: 1;
        margin-left: 250px;
        padding: 20px;
      }

      .header {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        color: #1e3c72;
        font-size: 28px;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
      }

      .sync-btn:hover {
        background: #218838 !important;
        transform: translateY(-1px);
      }

      .sync-btn:disabled {
        background: #6c757d !important;
        cursor: not-allowed;
        transform: none;
      }

      .content-section {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
      }

      .section-header h2 {
        color: #1e3c72;
        font-size: 24px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(30, 60, 114, 0.3);
      }

      .welcome-message {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .welcome-message h3 {
        font-size: 24px;
        margin-bottom: 15px;
        color: #1e3c72;
      }

      .welcome-message p {
        font-size: 16px;
        line-height: 1.6;
        margin-bottom: 20px;
      }

      .api-endpoints {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
      }

      .api-endpoints h4 {
        color: #1e3c72;
        margin-bottom: 15px;
      }

      .endpoint-item {
        margin-bottom: 10px;
        padding: 10px;
        background: white;
        border-radius: 6px;
        border-left: 4px solid #2a5298;
      }

      .endpoint-item code {
        background: #e9ecef;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: "Courier New", monospace;
        color: #d63384;
      }

      .logout-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .logout-btn:hover {
        background: #c82333;
      }

      .table-container {
        overflow-x: auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .employees-table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
      }

      .employees-table th {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #ddd;
      }

      .employees-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
        vertical-align: middle;
      }

      .employees-table tr:hover {
        background: #f8f9fa;
      }

      .employee-name {
        font-weight: 600;
        color: #1e3c72;
      }

      .employee-email {
        color: #666;
        font-size: 14px;
      }

      .document-count {
        display: inline-block;
        background: #e3f2fd;
        color: #1565c0;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }

      .action-buttons {
        display: flex;
        gap: 8px;
      }

      .btn-action {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        transition: all 0.3s ease;
      }

      .btn-view {
        background: #17a2b8;
        color: white;
      }

      .btn-view:hover {
        background: #138496;
      }

      .btn-edit {
        background: #ffc107;
        color: #212529;
      }

      .btn-edit:hover {
        background: #e0a800;
      }

      .btn-delete {
        background: #dc3545;
        color: white;
      }

      .btn-delete:hover {
        background: #c82333;
      }

      /* Custom modal styles - only for non-Bootstrap modals */
      .custom-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .custom-modal .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
      }

      .custom-modal .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }

      .custom-modal .modal-header h3 {
        color: #1e3c72;
        margin: 0;
      }

      .custom-modal .close {
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        color: #999;
      }

      .custom-modal .close:hover {
        color: #333;
      }

      .documents-list {
        margin-top: 20px;
      }

      .document-item {
        background: #f8f9fa;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        border-left: 4px solid #2a5298;
      }

      .document-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .document-type {
        font-weight: 600;
        color: #1e3c72;
      }

      .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-en-attente {
        background: #fff3cd;
        color: #856404;
      }

      .status-en-cours {
        background: #fff3cd;
        color: #856404;
      }

      .status-accepte {
        background: #d4edda;
        color: #155724;
      }

      .status-refuse {
        background: #f8d7da;
        color: #721c24;
      }

      /* Pending Requests Section Styles */
      .section-content {
        margin-bottom: 30px;
      }

      .section-header h2 i {
        margin-right: 10px;
        color: #ffc107;
      }

      .stats-badge {
        background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 14px;
      }

      .btn-approve {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        margin-right: 5px;
        transition: all 0.3s ease;
        font-size: 12px;
      }

      .btn-approve:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
      }

      .btn-reject {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 12px;
      }

      .btn-reject:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
      }

      .status-pending {
        background: #fff3cd;
        color: #856404;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .document-description {
        color: #666;
        font-size: 14px;
        margin-bottom: 10px;
      }

      .document-actions {
        display: flex;
        gap: 8px;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .loading i {
        font-size: 24px;
        margin-bottom: 10px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 768px) {
        .sidebar {
          width: 200px;
        }

        .main-content {
          margin-left: 200px;
        }

        .employees-table {
          font-size: 14px;
        }

        .employees-table th,
        .employees-table td {
          padding: 8px;
        }

        .action-buttons {
          flex-direction: column;
        }
      }

      /* News Management Styles */
      .news-filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .filter-group label {
        font-weight: 600;
        color: #333;
        font-size: 12px;
        text-transform: uppercase;
      }

      .filter-group select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        min-width: 150px;
      }

      .news-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .news-table th,
      .news-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #eee;
        vertical-align: middle;
      }

      .news-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .news-table tbody tr:hover {
        background: #f8f9fa;
      }

      /* Badge Styles */
      .badge {
        display: inline-block;
        padding: 4px 8px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        border-radius: 12px;
        color: white;
        letter-spacing: 0.3px;
      }

      .badge-success {
        background-color: #28a745;
      }

      .badge-warning {
        background-color: #ffc107;
        color: #212529;
      }

      .badge-danger {
        background-color: #dc3545;
      }

      .badge-primary {
        background-color: #007bff;
      }

      .badge-secondary {
        background-color: #6c757d;
      }

      .badge-info {
        background-color: #17a2b8;
      }

      /* News Modal Styles */
      .news-modal .modal-body {
        max-height: 70vh;
        overflow-y: auto;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        font-family: inherit;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 100px;
      }

      .form-row {
        display: flex;
        gap: 15px;
      }

      .form-row .form-group {
        flex: 1;
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <div class="sidebar">
        <div class="sidebar-header">
          <h2>LEOIN</h2>
          <p>Admin Panel</p>
        </div>
        <nav>
          <ul class="nav-menu">
            <li>
              <a href="#employees" id="employeesLink" class="active"
                ><i class="fas fa-users"></i> Employees</a
              >
            </li>
            <li id="adminsMenuLi" style="display: none;">
              <a href="#admins" id="adminsLink"
                ><i class="fas fa-user-shield"></i> Admins</a
              >
            </li>
            <li>
              <a href="#pending-requests" id="pendingRequestsLink"
                ><i class="fas fa-user-clock"></i> Pending Requests</a
              >
            </li>
            <li>
              <a href="#document-types" id="documentTypesLink"
                ><i class="fas fa-file-alt"></i> Document Types</a
              >
            </li>
            <li>
              <a href="#news" id="newsLink"
                ><i class="fas fa-newspaper"></i> Actualités</a
              >
            </li>
          </ul>
        </nav>
      </div>

      <div class="main-content">
        <div class="header">
          <h1 id="mainTitle">LEOIN Management</h1>
          <div class="user-info">
            <button
              onclick="syncData()"
              class="sync-btn"
              style="
                background: #28a745;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                margin-right: 15px;
              "
            >
              <i class="fas fa-sync-alt"></i> Sync Data
            </button>
            <div class="user-avatar">A</div>
            <span id="currentAdminName">Admin User</span>
            <button
              onclick="logout()"
              class="logout-btn"
              style="
                background: #dc3545;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                margin-left: 15px;
              "
            >
              <i class="fas fa-sign-out-alt"></i>
              Logout
            </button>
          </div>
        </div>

        <div class="content-section" id="mainContentSection">
          <div class="section-header">
            <h2 id="sectionTitle">Employee Management</h2>
            <button
              class="btn-primary"
              id="addEmployeeBtn"
              onclick="showAddEmployeeModal()"
            >
              <i class="fas fa-plus"></i>
              Add Employee
            </button>
          </div>

          <!-- Employee Filters -->
          <div
            id="employeeFilters"
            class="filters-container"
            style="
              margin-bottom: 20px;
              padding: 15px;
              background: #f8f9fa;
              border-radius: 8px;
            "
          >
            <h4 style="margin-bottom: 15px; color: #1e3c72">
              Filtres des Employés
            </h4>
            <div
              style="
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
              "
            >
              <div>
                <label
                  style="display: block; margin-bottom: 5px; font-weight: bold"
                  >Department:</label
                >
                <select
                  id="employeeDepartmentFilter"
                  style="
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                  "
                  onchange="applyEmployeeFilters()"
                >
                  <option value="">Tous les départements</option>
                </select>
              </div>
              <div>
                <label
                  style="display: block; margin-bottom: 5px; font-weight: bold"
                  >Location:</label
                >
                <select
                  id="employeeLocationFilter"
                  style="
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                  "
                  onchange="applyEmployeeFilters()"
                >
                  <option value="">Toutes les locations</option>
                </select>
              </div>
              <div>
                <label
                  style="display: block; margin-bottom: 5px; font-weight: bold"
                  >Position:</label
                >
                <select
                  id="employeePositionFilter"
                  style="
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                  "
                  onchange="applyEmployeeFilters()"
                >
                  <option value="">Toutes les positions</option>
                </select>
              </div>
              <div style="display: flex; align-items: end">
                <button
                  onclick="clearEmployeeFilters()"
                  style="
                    background: #6c757d;
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 4px;
                    cursor: pointer;
                  "
                >
                  Réinitialiser
                </button>
              </div>
            </div>
          </div>

          <div id="employeeTable" class="table-container">
            <table class="employees-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Address 1</th>
                  <th>Department</th>
                  <th>Location</th>
                  <th>Position</th>
                  <th>Documents</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="employeeTableBody">
                <!-- Employee data will be loaded here -->
              </tbody>
            </table>
          </div>

          <div
            id="welcomeMessage"
            class="welcome-message"
            style="display: none"
          >
            <h3>🎉 System Ready for React Development!</h3>
            <p>
              Your backend API is fully configured and ready to be integrated
              with a React frontend. The admin panel provides comprehensive
              employee and document management capabilities.
            </p>

            <div class="api-endpoints">
              <h4>Available API Endpoints:</h4>
              <div class="endpoint-item">
                <strong>Authentication:</strong>
                <code>POST /api/auth/login</code>
              </div>
              <div class="endpoint-item">
                <strong>Employees:</strong>
                <code>GET/POST/PUT/DELETE /api/admin/employees</code>
              </div>
              <div class="endpoint-item">
                <strong>Documents:</strong>
                <code>GET/POST/PUT/DELETE /api/admin/documents</code>
              </div>
              <div class="endpoint-item">
                <strong>Dashboard Stats:</strong>
                <code>GET /api/admin/dashboard/stats</code>
              </div>
            </div>
          </div>
        </div>

        <!-- Pending Requests Section -->
        <div
          class="content-section"
          id="pendingRequestsSection"
          style="display: none"
        >
          <div class="section-header">
            <h2>Pending User Requests</h2>
          </div>

          <div id="pendingRequestsTable" class="table-container">
            <table class="employees-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Address 1</th>
                  <th>Address 2</th>
                  <th>Phone</th>
                  <th>Department</th>
                  <th>Location</th>
                  <th>Position</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="pendingRequestsTableBody">
                <!-- Pending requests will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Document Types Section -->
        <div
          class="content-section"
          id="documentTypesSection"
          style="display: none"
        >
          <div class="section-header">
            <h2 id="documentTypesTitle">Document Types</h2>
            <button
              class="btn-primary"
              id="addDocumentTypeBtn"
              onclick="showAddDocumentTypeModal()"
            >
              <i class="fas fa-plus"></i>
              Add Document Type
            </button>
          </div>

          <div id="documentTypesTable" class="table-container">
            <table class="employees-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Description</th>
                  <th>Status</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="documentTypesTableBody">
                <!-- Document types will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- News Section -->
        <div class="content-section" id="newsSection" style="display: none">
          <div class="section-header">
            <h2 id="newsSectionTitle">Actualités</h2>
            <button
              class="btn-primary"
              id="addNewsBtn"
              onclick="showAddNewsModal()"
            >
              <i class="fas fa-plus"></i>
              Poster une actualité
            </button>
          </div>

          <!-- SuperAdmin Filters (will be shown only for SUPERADMIN role) -->
          <div
            id="superAdminFilters"
            class="filters-container"
            style="
              display: none;
              margin-bottom: 20px;
              padding: 15px;
              background: #f8f9fa;
              border-radius: 8px;
            "
          >
            <h4 style="margin-bottom: 15px; color: #1e3c72">
              Filtres (SuperAdmin)
            </h4>
            <div
              style="
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
              "
            >
              <div>
                <label
                  style="display: block; margin-bottom: 5px; font-weight: bold"
                  >Location:</label
                >
                <select
                  id="filterLocation"
                  style="
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                  "
                >
                  <option value="">Toutes les locations</option>
                </select>
              </div>
              <div>
                <label
                  style="display: block; margin-bottom: 5px; font-weight: bold"
                  >Département:</label
                >
                <select
                  id="filterDepartment"
                  style="
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                  "
                >
                  <option value="">Tous les départements</option>
                </select>
              </div>

              <div style="display: flex; align-items: end">
                <button
                  onclick="applyNewsFilters()"
                  style="
                    background: #007bff;
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 4px;
                    cursor: pointer;
                  "
                >
                  Appliquer les filtres
                </button>
              </div>
            </div>
          </div>

          <div id="newsTable" class="table-container">
            <table class="employees-table">
              <thead>
                <tr>
                  <th>Titre</th>
                  <th>Catégorie</th>
                  <th>Priorité</th>
                  <th>Location cible</th>
                  <th>Département cible</th>
                  <th>Statut</th>
                  <th>Créé par</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="newsTableBody">
                <!-- News will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Admins Section (SuperAdmin only) -->
        <div class="content-section" id="adminsSection" style="display: none">
          <div class="section-header">
            <h2 id="adminsSectionTitle">Gestion des Admins</h2>
            <div style="display: flex; gap: 10px;">
              <button
                class="btn-primary"
                id="addAdminBtn"
                onclick="showAddAdminModal()"
              >
                <i class="fas fa-plus"></i>
                Ajouter Admin
              </button>
              <button
                class="btn btn-info"
                onclick="loadAdminsStats()"
              >
                <i class="fas fa-chart-bar"></i>
                Statistiques
              </button>
            </div>
          </div>

          <div id="adminsTable" class="table-container">
            <table class="employees-table">
              <thead>
                <tr>
                  <th>Nom d'utilisateur</th>
                  <th>Prénom</th>
                  <th>Nom</th>
                  <th>Email</th>
                  <th>Département</th>
                  <th>Location</th>
                  <th>Statut</th>
                  <th>Dernière connexion</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="adminsTableBody">
                <!-- Admins will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    >

    <!-- Employee View Modal -->
    <div id="employeeModal" class="custom-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalTitle">Employee Details</h3>
          <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div id="modalBody">
          <!-- Employee details and documents will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Document Type Modal -->
    <div id="documentTypeModal" class="custom-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="documentTypeModalTitle">Add Document Type</h3>
          <span class="close" onclick="closeDocumentTypeModal()">&times;</span>
        </div>
        <div id="documentTypeModalBody">
          <form id="documentTypeForm">
            <div style="margin-bottom: 15px">
              <label
                style="display: block; margin-bottom: 5px; font-weight: bold"
                >Name:</label
              >
              <input
                type="text"
                id="documentTypeName"
                required
                style="
                  width: 100%;
                  padding: 8px;
                  border: 1px solid #ddd;
                  border-radius: 4px;
                "
              />
            </div>
            <div style="margin-bottom: 15px">
              <label
                style="display: block; margin-bottom: 5px; font-weight: bold"
                >Description:</label
              >
              <textarea
                id="documentTypeDescription"
                rows="3"
                style="
                  width: 100%;
                  padding: 8px;
                  border: 1px solid #ddd;
                  border-radius: 4px;
                "
              ></textarea>
            </div>
            <div style="margin-bottom: 20px">
              <label style="display: flex; align-items: center; gap: 8px">
                <input type="checkbox" id="documentTypeActive" checked />
                <span>Active</span>
              </label>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end">
              <button
                type="button"
                onclick="closeDocumentTypeModal()"
                style="
                  background: #6c757d;
                  color: white;
                  border: none;
                  padding: 10px 20px;
                  border-radius: 4px;
                  cursor: pointer;
                "
              >
                Cancel
              </button>
              <button
                type="submit"
                style="
                  background: #007bff;
                  color: white;
                  border: none;
                  padding: 10px 20px;
                  border-radius: 4px;
                  cursor: pointer;
                "
              >
                Save Document Type
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- News Modal -->
    <div
      id="newsModal"
      class="modal fade"
      tabindex="-1"
      aria-labelledby="newsModalTitle"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h3 id="newsModalTitle" class="modal-title">Créer une actualité</h3>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" id="newsModalBody">
            <form id="newsForm">
              <!-- Hidden field for edit mode -->
              <input type="hidden" id="newsId" value="" />
              <div
                style="
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 20px;
                  margin-bottom: 15px;
                "
              >
                <div>
                  <label
                    style="
                      display: block;
                      margin-bottom: 5px;
                      font-weight: bold;
                    "
                    >Titre *:</label
                  >
                  <input
                    type="text"
                    id="newsTitle"
                    required
                    style="
                      width: 100%;
                      padding: 8px;
                      border: 1px solid #ddd;
                      border-radius: 4px;
                    "
                  />
                </div>
                <div>
                  <label
                    style="
                      display: block;
                      margin-bottom: 5px;
                      font-weight: bold;
                    "
                    >Catégorie *:</label
                  >
                  <select
                    id="newsCategory"
                    required
                    style="
                      width: 100%;
                      padding: 8px;
                      border: 1px solid #ddd;
                      border-radius: 4px;
                    "
                  >
                    <option value="">Sélectionner une catégorie</option>
                    <option value="general">Général</option>
                    <option value="safety">Sécurité</option>
                    <option value="hr">RH</option>
                    <option value="technical">Technique</option>
                  </select>
                </div>
              </div>

              <div
                style="
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 20px;
                  margin-bottom: 15px;
                "
              >
                <div>
                  <label
                    style="
                      display: block;
                      margin-bottom: 5px;
                      font-weight: bold;
                    "
                    >Priorité *:</label
                  >
                  <select
                    id="newsPriority"
                    required
                    style="
                      width: 100%;
                      padding: 8px;
                      border: 1px solid #ddd;
                      border-radius: 4px;
                    "
                  >
                    <option value="">Sélectionner une priorité</option>
                    <option value="normal">Normal</option>
                    <option value="important">Important</option>
                    <option value="urgent">Urgent</option>
                  </select>
                </div>
                <div>
                  <label
                    style="
                      display: block;
                      margin-bottom: 5px;
                      font-weight: bold;
                    "
                    >Statut:</label
                  >
                  <select
                    id="newsStatus"
                    style="
                      width: 100%;
                      padding: 8px;
                      border: 1px solid #ddd;
                      border-radius: 4px;
                    "
                  >
                    <option value="draft">Brouillon</option>
                    <option value="published">Publié</option>
                  </select>
                </div>
              </div>

              <!-- SuperAdmin target fields (will be shown only for SUPERADMIN) -->
              <div
                id="superAdminTargetFields"
                style="display: none; margin-bottom: 15px"
              >
                <div
                  style="
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 20px;
                  "
                >
                  <div>
                    <label
                      style="
                        display: block;
                        margin-bottom: 5px;
                        font-weight: bold;
                      "
                      >Location cible *:</label
                    >
                    <select
                      id="newsTargetLocation"
                      style="
                        width: 100%;
                        padding: 8px;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                      "
                    >
                      <option value="">Sélectionner une location</option>
                    </select>
                  </div>
                  <div>
                    <label
                      style="
                        display: block;
                        margin-bottom: 5px;
                        font-weight: bold;
                      "
                      >Département cible *:</label
                    >
                    <select
                      id="newsTargetDepartment"
                      style="
                        width: 100%;
                        padding: 8px;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                      "
                    >
                      <option value="">Sélectionner un département</option>
                    </select>
                  </div>
                </div>
              </div>

              <div style="margin-bottom: 15px">
                <label
                  style="display: block; margin-bottom: 5px; font-weight: bold"
                  >Résumé:</label
                >
                <textarea
                  id="newsSummary"
                  rows="2"
                  placeholder="Résumé court de l'actualité..."
                  style="
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                  "
                ></textarea>
              </div>

              <!-- Image upload section -->
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                  Image (optionnelle):
                </label>
                <div style="border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center;">
                  <input 
                    type="file" 
                    id="newsImageFile" 
                    accept="image/*" 
                    style="display: none;"
                    onchange="handleImageUpload()"
                  />
                  <div id="imageUploadArea" onclick="document.getElementById('newsImageFile').click()" style="cursor: pointer;">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #ddd; margin-bottom: 10px;"></i>
                    <p style="margin: 0; color: #666;">Cliquez pour sélectionner une image</p>
                    <p style="margin: 5px 0 0 0; font-size: 12px; color: #999;">
                      Formats supportés: JPG, PNG, GIF (max 5MB)
                    </p>
                  </div>
                  <div id="imagePreviewArea" style="display: none;">
                    <img id="imagePreview" style="max-width: 100%; max-height: 200px; border-radius: 4px; margin-bottom: 10px;" />
                    <p id="imageInfo" style="margin: 0; font-size: 14px; color: #666;"></p>
                    <button type="button" onclick="removeImage()" style="margin-top: 10px; background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                      <i class="fas fa-trash"></i> Supprimer
                    </button>
                  </div>
                  <div id="uploadProgress" style="display: none; margin-top: 10px;">
                    <div style="background: #e9ecef; border-radius: 4px; overflow: hidden;">
                      <div id="progressBar" style="background: #007bff; height: 6px; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <p style="margin: 5px 0 0 0; font-size: 14px; color: #666;">Upload en cours...</p>
                  </div>
                </div>
                <input type="hidden" id="newsImageUrl" />
                <input type="hidden" id="newsImageName" />
              </div>

              <div style="margin-bottom: 20px">
                <label
                  style="display: block; margin-bottom: 5px; font-weight: bold"
                  >Contenu *:</label
                >
                <textarea
                  id="newsContent"
                  rows="6"
                  required
                  placeholder="Contenu détaillé de l'actualité..."
                  style="
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                  "
                ></textarea>
              </div>

              <!-- Image Upload Section -->
              <div style="margin-bottom: 20px">
                <label style="display: block; margin-bottom: 5px; font-weight: bold">
                  Image (optionnelle):
                </label>
                
                <!-- Image Upload Area -->
                <div id="imageUploadArea" style="border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer;" onclick="document.getElementById('newsImageFile').click();">
                  <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #ccc; margin-bottom: 10px;"></i>
                  <p style="margin: 0; color: #666;">Cliquez ici ou glissez une image</p>
                  <p style="margin: 5px 0 0 0; font-size: 12px; color: #999;">Formats acceptés: JPG, PNG, GIF (max 5MB)</p>
                  <input type="file" id="newsImageFile" accept="image/*" style="display: none;" onchange="handleImageUpload()" />
                </div>
                
                <!-- Upload Progress -->
                <div id="uploadProgress" style="display: none; margin-top: 10px;">
                  <div style="background: #e9ecef; border-radius: 4px; overflow: hidden;">
                    <div id="progressBar" style="background: #007bff; height: 6px; width: 100%; transition: width 0.3s;"></div>
                  </div>
                  <p style="margin: 5px 0 0 0; font-size: 14px; color: #666;">Upload en cours...</p>
                </div>
                
                <!-- Image Preview -->
                <div id="imagePreviewArea" style="display: none; margin-top: 10px; border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                  <div style="display: flex; align-items: center; gap: 15px;">
                    <img id="imagePreview" src="" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;" />
                    <div style="flex: 1;">
                      <p id="imageInfo" style="margin: 0; font-weight: bold; color: #333;">image.jpg</p>
                      <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">Image uploadée avec succès</p>
                    </div>
                    <button type="button" onclick="removeImage()" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
                
                <!-- Hidden fields for image data -->
                <input type="hidden" id="newsImageUrl" />
                <input type="hidden" id="newsImageName" />
              </div>

              <div style="display: flex; gap: 10px; justify-content: flex-end">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Annuler
                </button>
                <button type="submit" class="btn btn-primary">
                  Créer l'actualité
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let employees = [];
      let currentEmployee = null;

      // Load employees from API
      async function loadEmployees() {
        try {
          showLoading();

          // Get authentication token
          const token =
            localStorage.getItem("adminToken") ||
            sessionStorage.getItem("authToken");

          if (!token) {
            throw new Error("No authentication token found");
          }

          // Check if user is SuperAdmin
          const userRole = sessionStorage.getItem("userRole");
          const isSuperAdmin = userRole === "SUPERADMIN";

          console.log("loadEmployees - User role:", userRole, "isSuperAdmin:", isSuperAdmin);

          if (isSuperAdmin) {
            // SuperAdmin: Load ALL employees
            console.log("Loading ALL employees for SuperAdmin");
            const response = await fetch("/api/superadmin/employees");
            
            if (response.ok) {
              employees = await response.json();
              console.log("SuperAdmin loaded", employees.length, "employees");
              originalEmployees = [...employees]; // Store original data for filtering
              displayEmployees();
              // Load filter options after loading employees
              await loadEmployeeFilterOptions();
            } else {
              showError("Failed to load employees for SuperAdmin");
            }
          } else {
            // Regular Admin: Load filtered employees
            let adminUsername = sessionStorage.getItem("currentAdmin");

            if (!adminUsername) {
              console.log("loadEmployees - Getting username from API");
              const userResponse = await fetch("/api/auth/user-info", {
                headers: {
                  Authorization: `Bearer ${token}`,
                },
              });

              if (userResponse.ok) {
                const userInfo = await userResponse.json();
                adminUsername = userInfo.username;
                sessionStorage.setItem("currentAdmin", adminUsername);
                console.log(
                  "loadEmployees - Got username from API:",
                  adminUsername
                );
              } else {
                throw new Error(
                  `Failed to get user info: ${userResponse.status}`
                );
              }
            }

            console.log("loadEmployees - Using adminUsername:", adminUsername);

            // Update the admin name in the header
            document.getElementById(
              "currentAdminName"
            ).textContent = `Admin: ${adminUsername}`;

            console.log("Loading employees for admin:", adminUsername);
            const response = await fetch(
              `/api/admin/employees?adminUsername=${adminUsername}`
            );
            if (response.ok) {
              employees = await response.json();
              originalEmployees = [...employees]; // Store original data for filtering
              displayEmployees();
              // Load filter options after loading employees
              await loadEmployeeFilterOptions();
            } else {
              showError("Failed to load employees");
            }
          }
        } catch (error) {
          showError("Error loading employees: " + error.message);
        }
      }

      // Display employees in table
      function displayEmployees() {
        const tbody = document.getElementById("employeeTableBody");

        if (employees.length === 0) {
          tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-users" style="font-size: 48px; margin-bottom: 10px; opacity: 0.3;"></i>
                            <br>No employees found. Click "Add Employee" to create the first one.
                        </td>
                    </tr>
                `;
          return;
        }

        tbody.innerHTML = employees
          .map(
            (employee) => `
                <tr>
                    <td>${employee.employeeId || "N/A"}</td>
                    <td>
                        <div class="employee-name">${employee.firstName} ${
              employee.lastName
            }</div>
                        <div class="employee-email">${
                          employee.adresse1 || "N/A"
                        }</div>
                    </td>
                    <td>${employee.adresse1 || "N/A"}</td>
                    <td>${employee.department || "Not specified"}</td>
                    <td>${employee.location || "Not specified"}</td>
                    <td>${employee.position || "Not specified"}</td>
                    <td>
                        <span class="document-count" id="docCount-${
                          employee.id
                        }">Loading...</span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-view" onclick="viewEmployee('${
                              employee.id
                            }')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn-action btn-edit" onclick="editEmployee('${
                              employee.id
                            }')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn-action btn-delete" onclick="deleteEmployee('${
                              employee.id
                            }')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </td>
                </tr>
            `
          )
          .join("");

        // Load document counts after displaying the table
        loadDocumentCounts();
      }

      // Load document counts for all employees
      async function loadDocumentCounts() {
        for (const employee of employees) {
          try {
            const response = await fetch(
              `/api/admin/employees/${employee.id}/documents`
            );
            let documentCount = 0;

            if (response.ok) {
              const data = await response.json();
              const documents = Array.isArray(data)
                ? data
                : data.documents || [];
              documentCount = documents.length;
            } else {
              // Fallback to documentRequestIds if API fails
              documentCount = employee.documentRequestIds
                ? employee.documentRequestIds.length
                : 0;
            }

            const countElement = document.getElementById(
              `docCount-${employee.id}`
            );
            if (countElement) {
              countElement.textContent = `${documentCount} docs`;
            }
          } catch (error) {
            console.error(
              `Error loading documents for employee ${employee.id}:`,
              error
            );
            const countElement = document.getElementById(
              `docCount-${employee.id}`
            );
            if (countElement) {
              const fallbackCount = employee.documentRequestIds
                ? employee.documentRequestIds.length
                : 0;
              countElement.textContent = `${fallbackCount} docs`;
            }
          }
        }
      }

      // Load pending user requests
      async function loadPendingRequests() {
        try {
          showLoading();
          const response = await fetch("/api/admin/employees/pending");
          if (response.ok) {
            const pendingUsers = await response.json();
            displayPendingRequests(pendingUsers);

            // Note: Title removed from UI - count displayed in table only
          } else {
            showError("Failed to load pending requests");
          }
        } catch (error) {
          showError("Error loading pending requests: " + error.message);
        }
      }

      // Display pending requests in table
      function displayPendingRequests(pendingUsers) {
        const tbody = document.getElementById("pendingRequestsTableBody");

        if (pendingUsers.length === 0) {
          tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-user-clock" style="font-size: 48px; margin-bottom: 10px; opacity: 0.3;"></i>
                            <br>No pending requests found. All users are approved!
                        </td>
                    </tr>
                `;
          return;
        }

        tbody.innerHTML = pendingUsers
          .map(
            (user) => `
                <tr>
                    <td>${user.employeeId || "N/A"}</td>
                    <td>
                        <div class="employee-name">${user.firstName} ${
              user.lastName
            }</div>
                    </td>
                    <td>${user.adresse1 || "N/A"}</td>
                    <td>${user.adresse2 || "N/A"}</td>
                    <td>${user.phoneNumber || "N/A"}</td>
                    <td>${user.department || "Not specified"}</td>
                    <td>${user.location || "Not specified"}</td>
                    <td>${user.position || "Not specified"}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-approve" onclick="approveUser('${
                              user.id
                            }')">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="btn-reject" onclick="rejectUser('${
                              user.id
                            }')">
                                <i class="fas fa-times"></i> Reject
                            </button>
                        </div>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      // Format date for display
      function formatDate(dateString) {
        if (!dateString) return "N/A";
        const date = new Date(dateString);
        return date.toLocaleDateString() + " " + date.toLocaleTimeString();
      }

      // Safe date formatting function
      function formatDateSafe(dateString) {
        if (!dateString) return "N/A";
        try {
          // Handle different date formats
          let date;

          // If it's already a Date object
          if (dateString instanceof Date) {
            date = dateString;
          }
          // If it's a timestamp (number)
          else if (typeof dateString === "number") {
            date = new Date(dateString);
          }
          // If it's a string, try to parse it
          else if (typeof dateString === "string") {
            // Handle ISO format, timestamp strings, etc.
            date = new Date(dateString);
          } else {
            return "N/A";
          }

          // Check if the date is valid
          if (isNaN(date.getTime())) {
            console.log("Invalid date:", dateString);
            return "N/A";
          }

          // Format as: Mon Jul 28 2025
          return date.toDateString();
        } catch (error) {
          console.log(
            "Date formatting error:",
            error,
            "for value:",
            dateString
          );
          return "N/A";
        }
      }

      // Approve user
      async function approveUser(userId) {
        if (
          !confirm(
            "Are you sure you want to approve this user? They will be able to login."
          )
        ) {
          return;
        }

        try {
          const response = await fetch(
            `/api/admin/employees/${userId}/approve`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );

          if (response.ok) {
            alert("User approved successfully!");
            loadPendingRequests(); // Reload the pending requests
            loadEmployees(); // Reload employees list
          } else {
            const error = await response.json();
            alert(
              "Failed to approve user: " + (error.message || "Unknown error")
            );
          }
        } catch (error) {
          alert("Error approving user: " + error.message);
        }
      }

      // Reject user
      async function rejectUser(userId) {
        if (
          !confirm(
            "Are you sure you want to reject this user? Their account will be deleted."
          )
        ) {
          return;
        }

        try {
          const response = await fetch(
            `/api/admin/employees/${userId}/reject`,
            {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );

          if (response.ok) {
            alert("User rejected and account deleted successfully!");
            loadPendingRequests(); // Reload the pending requests
          } else {
            const error = await response.json();
            alert(
              "Failed to reject user: " + (error.message || "Unknown error")
            );
          }
        } catch (error) {
          alert("Error rejecting user: " + error.message);
        }
      }

      // View employee details with documents
      async function viewEmployee(employeeId) {
        try {
          const employee = employees.find((emp) => emp.id === employeeId);
          if (!employee) {
            showError("Employee not found");
            return;
          }

          currentEmployee = employee;

          // Load employee documents
          const response = await fetch(
            `/api/admin/employees/${employeeId}/documents`
          );

          let documents = [];
          if (response.ok) {
            const data = await response.json();
            documents = Array.isArray(data) ? data : data.documents || [];
          } else {
            console.error("Failed to load documents for employee:", employeeId);
            showError("Failed to load documents for this employee");
          }

          document.getElementById(
            "modalTitle"
          ).textContent = `${employee.firstName} ${employee.lastName} - Details`;

          document.getElementById("modalBody").innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #1e3c72; margin-bottom: 10px;">Personal Information</h4>
                        <p><strong>Employee ID:</strong> ${
                          employee.employeeId || "N/A"
                        }</p>
                        <p><strong>Address 1:</strong> ${
                          employee.adresse1 || "N/A"
                        }</p>
                        <p><strong>Address 2:</strong> ${
                          employee.adresse2 || "N/A"
                        }</p>
                        <p><strong>Phone:</strong> ${
                          employee.phoneNumber || "N/A"
                        }</p>
                        <p><strong>Department:</strong> ${
                          employee.department || "Not specified"
                        }</p>
                        <p><strong>Position:</strong> ${
                          employee.position || "Not specified"
                        }</p>
                        <p><strong>Created:</strong> ${
                          employee.createdAt
                            ? formatDateSafe(employee.createdAt)
                            : "N/A"
                        }</p>
                    </div>
                    
                    <div class="documents-list">
                        <h4 style="color: #1e3c72; margin-bottom: 15px;">Documents (${
                          documents.length
                        })</h4>
                        ${
                          documents.length === 0
                            ? '<p style="color: #666; font-style: italic;">No documents found for this employee.</p>'
                            : documents
                                .map(
                                  (doc) => `
                                <div class="document-item">
                                    <div class="document-header">
                                        <span class="document-type">${
                                          doc.documentTypes &&
                                          doc.documentTypes.length > 0
                                            ? doc.documentTypes.join(", ")
                                            : doc.documentType || "Unknown Type"
                                        }</span>
                                        <span class="status-badge status-${doc.status.current
                                          .replace(" ", "-")
                                          .replace(/é/g, "e")}">${
                                    doc.status.current
                                  }</span>
                                    </div>
                                    <div class="document-description">${
                                      doc.description || "No description"
                                    }</div>
                                    <div class="document-meta" style="color: #666; font-size: 12px; margin-top: 8px;">
                                        <span>Created: ${
                                          doc.createdAt
                                            ? formatDateSafe(doc.createdAt)
                                            : "N/A"
                                        }</span>
                                        ${
                                          doc.updatedAt
                                            ? ` | Updated: ${formatDateSafe(
                                                doc.updatedAt
                                              )}`
                                            : ""
                                        }
                                    </div>
                                </div>
                            `
                                )
                                .join("")
                        }
                    </div>
                `;

          document.getElementById("employeeModal").style.display = "block";
        } catch (error) {
          showError("Error loading employee details: " + error.message);
        }
      }

      // Edit employee
      async function editEmployee(employeeId) {
        try {
          const employee = employees.find((emp) => emp.id === employeeId);
          if (!employee) {
            showError("Employee not found");
            return;
          }

          // Set current employee for editing
          currentEmployee = employee;

          // Load employee documents
          const response = await fetch(
            `/api/admin/employees/${employeeId}/documents`
          );

          let documents = [];
          if (response.ok) {
            const data = await response.json();
            documents = Array.isArray(data) ? data : data.documents || [];
          } else {
            console.error("Failed to load documents for employee:", employeeId);
          }

          // Set modal title
          document.getElementById(
            "modalTitle"
          ).textContent = `Edit Employee - ${employee.firstName} ${employee.lastName}`;

          // Create edit form with document management
          document.getElementById("modalBody").innerHTML = `
            <form id="editEmployeeForm" style="max-width: 100%;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                
                <!-- Employee Information Section -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                  <h4 style="color: #1e3c72; margin-bottom: 15px;">Employee Information</h4>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                      <label style="display: block; margin-bottom: 5px; font-weight: bold;">First Name:</label>
                      <input type="text" id="editFirstName" value="${
                        employee.firstName || ""
                      }" 
                             style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                    </div>
                    <div>
                      <label style="display: block; margin-bottom: 5px; font-weight: bold;">Last Name:</label>
                      <input type="text" id="editLastName" value="${
                        employee.lastName || ""
                      }" 
                             style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                    </div>
                  </div>
                  
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                      <label style="display: block; margin-bottom: 5px; font-weight: bold;">Employee ID:</label>
                      <input type="text" id="editEmployeeId" value="${
                        employee.employeeId || ""
                      }" 
                             style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                    </div>
                    <div>
                      <label style="display: block; margin-bottom: 5px; font-weight: bold;">Address 1:</label>
                      <input type="email" id="editAdresse1" value="${
                        employee.adresse1 || ""
                      }" 
                             style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                    </div>
                  </div>
                  
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                      <label style="display: block; margin-bottom: 5px; font-weight: bold;">Address 2:</label>
                      <input type="email" id="editAdresse2" value="${
                        employee.adresse2 || ""
                      }" 
                             style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div>
                      <label style="display: block; margin-bottom: 5px; font-weight: bold;">Phone Number:</label>
                      <input type="tel" id="editPhoneNumber" value="${
                        employee.phoneNumber || ""
                      }" 
                             style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                  </div>
                  
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                      <label style="display: block; margin-bottom: 5px; font-weight: bold;">Department:</label>
                      <input type="text" id="editDepartment" value="${
                        employee.department || ""
                      }" 
                             style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div>
                      <label style="display: block; margin-bottom: 5px; font-weight: bold;">Location:</label>
                      <input type="text" id="editLocation" value="${
                        employee.location || ""
                      }" 
                             style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                  </div>
                  
                  <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Position:</label>
                    <input type="text" id="editPosition" value="${
                      employee.position || ""
                    }" 
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                  </div>
                  
                  <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" onclick="closeModal()" 
                            style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                      Cancel
                    </button>
                    <button type="submit" 
                            style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                      Update Employee & Documents
                    </button>
                  </div>
                </div>
                
                <!-- Document Management Section -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                  <h4 style="color: #1e3c72; margin-bottom: 15px;">Document Management (${
                    documents.length
                  })</h4>
                  <div id="documentsContainer" style="max-height: 400px; overflow-y: auto;">
                    ${
                      documents.length === 0
                        ? '<p style="color: #666; font-style: italic;">No documents found for this employee.</p>'
                        : documents
                            .map(
                              (doc) => `
                            <div class="document-item" style="margin-bottom: 15px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 6px; background: white;">
                                <div class="document-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span class="document-type" style="font-weight: bold; color: #1e3c72;">${
                                      doc.documentTypes &&
                                      doc.documentTypes.length > 0
                                        ? doc.documentTypes.join(", ")
                                        : doc.documentType || "Unknown Type"
                                    }</span>
                                    <span class="status-badge status-${doc.status.current
                                      .replace(" ", "-")
                                      .replace(
                                        /é/g,
                                        "e"
                                      )}" style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">${
                                doc.status.current
                              }</span>
                                </div>
                                <div class="document-description" style="color: #666; margin-bottom: 10px;">${
                                  doc.description || "No description"
                                }</div>
                                <div class="document-actions" style="display: flex; gap: 8px; align-items: center;">
                                    <div style="flex: 1;">
                                        <label style="font-size: 11px; color: #666; margin-bottom: 2px; display: block;">Status:</label>
                                        <select id="status-${
                                          doc.id
                                        }" style="width: 100%; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                            <option value="en attente" ${
                                              doc.status.current ===
                                              "en attente"
                                                ? "selected"
                                                : ""
                                            }>En attente</option>
                                            <option value="en cours" ${
                                              doc.status.current === "en cours"
                                                ? "selected"
                                                : ""
                                            }>En cours</option>
                                            <option value="accepté" ${
                                              doc.status.current === "accepté"
                                                ? "selected"
                                                : ""
                                            }>Accepté</option>
                                            <option value="refusé" ${
                                              doc.status.current === "refusé"
                                                ? "selected"
                                                : ""
                                            }>Refusé</option>
                                        </select>
                                    </div>
                                    <button class="btn-action btn-delete" onclick="deleteDocument('${
                                      doc.id
                                    }')" 
                                            style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 8px;">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        `
                            )
                            .join("")
                    }
                  </div>
                </div>
                
              </div>
            </form>
          `;

          // Add form submit handler
          document
            .getElementById("editEmployeeForm")
            .addEventListener("submit", updateEmployee);

          // Show modal
          document.getElementById("employeeModal").style.display = "block";
        } catch (error) {
          showError("Error loading employee details: " + error.message);
        }
      }

      // Update employee function
      async function updateEmployee(event) {
        event.preventDefault();

        const formData = {
          firstName: document.getElementById("editFirstName").value,
          lastName: document.getElementById("editLastName").value,
          employeeId: document.getElementById("editEmployeeId").value,
          adresse1: document.getElementById("editAdresse1").value,
          adresse2: document.getElementById("editAdresse2").value,
          phoneNumber: document.getElementById("editPhoneNumber").value,
          department: document.getElementById("editDepartment").value,
          location: document.getElementById("editLocation").value,
          position: document.getElementById("editPosition").value,
        };

        try {
          // Update employee information
          const response = await fetch(
            `/api/admin/employees/${currentEmployee.id}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(formData),
            }
          );

          if (response.ok) {
            // Update document statuses
            const documentsContainer =
              document.getElementById("documentsContainer");
            const statusSelects = documentsContainer.querySelectorAll(
              "select[id^='status-']"
            );

            let statusUpdatesSuccessful = true;

            for (const select of statusSelects) {
              const documentId = select.id.replace("status-", "");
              const newStatus = select.value;

              try {
                const statusResponse = await fetch(
                  `/api/admin/documents/${documentId}/status`,
                  {
                    method: "PUT",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                      status: newStatus,
                    }),
                  }
                );

                if (!statusResponse.ok) {
                  statusUpdatesSuccessful = false;
                  console.error(
                    `Failed to update status for document ${documentId}`
                  );
                }
              } catch (error) {
                statusUpdatesSuccessful = false;
                console.error(
                  `Error updating status for document ${documentId}:`,
                  error
                );
              }
            }

            if (statusUpdatesSuccessful) {
              showMessage(
                "Employee and document statuses updated successfully"
              );
            } else {
              showMessage(
                "Employee updated successfully, but some document statuses may not have been updated"
              );
            }

            closeModal();
            loadEmployees(); // Reload the table
          } else {
            const error = await response.text();
            showError("Failed to update employee: " + error);
          }
        } catch (error) {
          showError("Error updating employee: " + error.message);
        }
      }

      // Delete employee
      async function deleteEmployee(employeeId) {
        const employee = employees.find((emp) => emp.id === employeeId);
        if (!employee) return;

        if (
          confirm(
            `Are you sure you want to delete ${employee.firstName} ${employee.lastName}?`
          )
        ) {
          try {
            const response = await fetch(`/api/admin/employees/${employeeId}`, {
              method: "DELETE",
            });

            if (response.ok) {
              showMessage("Employee deleted successfully");
              loadEmployees(); // Reload the table
            } else {
              showError("Failed to delete employee");
            }
          } catch (error) {
            showError("Error deleting employee: " + error.message);
          }
        }
      }

      // Delete document
      async function deleteDocument(documentId) {
        if (confirm("Are you sure you want to delete this document?")) {
          try {
            const response = await fetch(`/api/admin/documents/${documentId}`, {
              method: "DELETE",
            });

            if (response.ok) {
              showMessage("Document deleted successfully");
              // Refresh the current employee edit view
              editEmployee(currentEmployee.id);
              loadEmployees(); // Reload to update document counts
            } else {
              showError("Failed to delete document");
            }
          } catch (error) {
            showError("Error deleting document: " + error.message);
          }
        }
      }

      // Show loading state
      function showLoading() {
        document.getElementById("employeeTableBody").innerHTML = `
                <tr>
                    <td colspan="7" class="loading">
                        <i class="fas fa-spinner"></i>
                        <br>Loading employees...
                    </td>
                </tr>
            `;
      }

      // Show error message
      function showError(message) {
        document.getElementById("employeeTableBody").innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: #dc3545;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 10px;"></i>
                        <br>${message}
                    </td>
                </tr>
            `;
      }

      // Close modal
      function closeModal() {
        document.getElementById("employeeModal").style.display = "none";
      }

      // Show add employee modal (placeholder)
      function showAddEmployeeModal() {
        alert("Add Employee functionality will be implemented here.");
      }

      // === DOCUMENT TYPE MANAGEMENT FUNCTIONS ===

      let documentTypes = [];
      let currentDocumentType = null;

      // Load document types from API
      async function loadDocumentTypes() {
        try {
          showDocumentTypesLoading();
          const response = await fetch("/api/admin/document-types");
          if (response.ok) {
            documentTypes = await response.json();
            displayDocumentTypes();
          } else {
            showDocumentTypesError("Failed to load document types");
          }
        } catch (error) {
          showDocumentTypesError(
            "Error loading document types: " + error.message
          );
        }
      }

      // Display document types in table
      function displayDocumentTypes() {
        const tbody = document.getElementById("documentTypesTableBody");

        if (documentTypes.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" style="text-align: center; padding: 40px; color: #666;">
                <i class="fas fa-file-alt" style="font-size: 48px; margin-bottom: 10px; opacity: 0.3;"></i>
                <br>No document types found. Click "Add Document Type" to create the first one.
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = documentTypes
          .map(
            (docType) => `
              <tr>
                <td>
                  <div style="font-weight: 600; color: #1e3c72;">${
                    docType.name
                  }</div>
                </td>
                <td>${docType.description || "No description"}</td>
                <td>
                  <span class="status-badge ${
                    docType.active ? "status-accepte" : "status-refuse"
                  }">
                    ${docType.active ? "Active" : "Inactive"}
                  </span>
                </td>
                <td>${formatDateSafe(docType.createdAt)}</td>
                <td>
                  <div class="action-buttons">
                    <button class="btn-action btn-edit" onclick="editDocumentType('${
                      docType.id
                    }')">
                      <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn-action ${
                      docType.active ? "btn-delete" : "btn-view"
                    }" 
                            onclick="toggleDocumentTypeStatus('${docType.id}')">
                      <i class="fas ${
                        docType.active ? "fa-ban" : "fa-check"
                      }"></i> 
                      ${docType.active ? "Deactivate" : "Activate"}
                    </button>
                    <button class="btn-action btn-delete" onclick="deleteDocumentType('${
                      docType.id
                    }')">
                      <i class="fas fa-trash"></i> Delete
                    </button>
                  </div>
                </td>
              </tr>
            `
          )
          .join("");
      }

      // Show add document type modal
      function showAddDocumentTypeModal() {
        currentDocumentType = null;
        document.getElementById("documentTypeModalTitle").textContent =
          "Add Document Type";
        document.getElementById("documentTypeName").value = "";
        document.getElementById("documentTypeDescription").value = "";
        document.getElementById("documentTypeActive").checked = true;
        document.getElementById("documentTypeModal").style.display = "block";
      }

      // Edit document type
      function editDocumentType(docTypeId) {
        const docType = documentTypes.find((dt) => dt.id === docTypeId);
        if (!docType) return;

        currentDocumentType = docType;
        document.getElementById("documentTypeModalTitle").textContent =
          "Edit Document Type";
        document.getElementById("documentTypeName").value = docType.name;
        document.getElementById("documentTypeDescription").value =
          docType.description || "";
        document.getElementById("documentTypeActive").checked = docType.active;
        document.getElementById("documentTypeModal").style.display = "block";
      }

      // Delete document type
      async function deleteDocumentType(docTypeId) {
        const docType = documentTypes.find((dt) => dt.id === docTypeId);
        if (!docType) return;

        if (
          confirm(
            `Are you sure you want to delete the document type "${docType.name}"?`
          )
        ) {
          try {
            const response = await fetch(
              `/api/admin/document-types/${docTypeId}`,
              {
                method: "DELETE",
              }
            );

            if (response.ok) {
              showMessage("Document type deleted successfully");
              loadDocumentTypes();
            } else {
              const error = await response.text();
              showError("Failed to delete document type: " + error);
            }
          } catch (error) {
            showError("Error deleting document type: " + error.message);
          }
        }
      }

      // Toggle document type status
      async function toggleDocumentTypeStatus(docTypeId) {
        try {
          const response = await fetch(
            `/api/admin/document-types/${docTypeId}/toggle-status`,
            {
              method: "PUT",
            }
          );

          if (response.ok) {
            showMessage("Document type status updated successfully");
            loadDocumentTypes();
          } else {
            const error = await response.text();
            showError("Failed to update document type status: " + error);
          }
        } catch (error) {
          showError("Error updating document type status: " + error.message);
        }
      }

      // Close document type modal
      function closeDocumentTypeModal() {
        document.getElementById("documentTypeModal").style.display = "none";
      }

      // Show loading state for document types
      function showDocumentTypesLoading() {
        document.getElementById("documentTypesTableBody").innerHTML = `
          <tr>
            <td colspan="5" class="loading">
              <i class="fas fa-spinner"></i>
              <br>Loading document types...
            </td>
          </tr>
        `;
      }

      // Show error message for document types
      function showDocumentTypesError(message) {
        document.getElementById("documentTypesTableBody").innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; padding: 40px; color: #dc3545;">
              <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 10px;"></i>
              <br>${message}
            </td>
          </tr>
        `;
      }

      // ==================== AUTHENTICATION FUNCTIONS ====================

      // Check authentication when dashboard loads
      async function checkAuthentication() {
        try {
          const token =
            localStorage.getItem("adminToken") ||
            sessionStorage.getItem("authToken");

          console.log(
            "checkAuthentication - Found token:",
            token ? "YES" : "NO"
          );

          if (!token) {
            console.warn("No authentication token found, redirecting to login");
            window.location.href = "/";
            return;
          }

          // Validate token with server
          const response = await fetch("/api/auth/user-info", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          console.log(
            "checkAuthentication - Server response status:",
            response.status
          );

          if (!response.ok) {
            console.warn("Invalid authentication token, redirecting to login");
            // Clear invalid tokens
            localStorage.removeItem("adminToken");
            sessionStorage.removeItem("authToken");
            sessionStorage.removeItem("currentAdmin");
            window.location.href = "/";
            return;
          }

          const userInfo = await response.json();
          console.log(
            "checkAuthentication - User authenticated:",
            userInfo.username,
            "Role:",
            userInfo.role
          );

          // Store user information in session storage
          sessionStorage.setItem("currentAdmin", userInfo.username);
          sessionStorage.setItem("userRole", userInfo.role);

          // Show/hide admin menu based on user role
          const adminMenuLink = document.querySelector('a[onclick="showAdminsSection()"]');
          if (adminMenuLink) {
            if (userInfo.role === "SUPERADMIN") {
              adminMenuLink.style.display = "block";
              console.log("checkAuthentication - Admin menu shown for SuperAdmin");
            } else {
              adminMenuLink.style.display = "none";
              console.log("checkAuthentication - Admin menu hidden for regular admin");
            }
          }

          // After successful authentication, load the data
          console.log("checkAuthentication - Now loading employees...");
          try {
            await loadEmployees();
            console.log("checkAuthentication - Employees loaded successfully");
          } catch (employeeError) {
            console.error(
              "checkAuthentication - Error loading employees:",
              employeeError
            );
            // Don't redirect on employee loading error, just show the dashboard without employees
            showError(
              "Erreur lors du chargement des employés: " + employeeError.message
            );
          }
        } catch (error) {
          console.error("Authentication check failed:", error);

          // Only redirect if it's an authentication error, not a data loading error
          if (
            (error.message && error.message.includes("401")) ||
            error.message.includes("authentication")
          ) {
            // Clear tokens and redirect on authentication error
            localStorage.removeItem("adminToken");
            sessionStorage.removeItem("authToken");
            sessionStorage.removeItem("currentAdmin");
            window.location.href = "/";
          } else {
            // For other errors, just log and show error message
            console.error("Non-authentication error:", error);
            showError(
              "Erreur lors du chargement du tableau de bord: " + error.message
            );
          }
        }
      }

      // ==================== NEWS MANAGEMENT FUNCTIONS ====================

      // Check user role and configure news section
      async function checkUserRoleAndConfigureNewsSection() {
        try {
          const token =
            localStorage.getItem("adminToken") ||
            sessionStorage.getItem("authToken");

          if (!token) {
            console.warn("No authentication token found for user-info");
            return;
          }

          const response = await fetch("/api/auth/user-info", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.ok) {
            const userInfo = await response.json();
            const isSuperAdmin = userInfo.role === "SUPERADMIN";

            // Show/hide superadmin filters
            const superAdminFilters =
              document.getElementById("superAdminFilters");
            if (superAdminFilters) {
              superAdminFilters.style.display = isSuperAdmin ? "block" : "none";
            }

            // Load filter options for superadmin
            if (isSuperAdmin) {
              await loadFilterOptions();
            }
          }
        } catch (error) {
          console.error("Error checking user role:", error);
        }
      }

      // Load filter options for superadmin
      async function loadFilterOptions() {
        try {
          const token = localStorage.getItem("adminToken");

          // Load locations
          const locationsResponse = await fetch("/api/users/locations", {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (locationsResponse.ok) {
            const locations = await locationsResponse.json();
            const locationSelect =
              document.getElementById("newsLocationFilter");
            if (locationSelect) {
              locationSelect.innerHTML =
                '<option value="">Toutes les locations</option>';
              locations.forEach((location) => {
                locationSelect.innerHTML += `<option value="${location}">${location}</option>`;
              });
            }
          }

          // Load departments
          const departmentsResponse = await fetch("/api/users/departments", {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (departmentsResponse.ok) {
            const departments = await departmentsResponse.json();
            const departmentSelect = document.getElementById(
              "newsDepartmentFilter"
            );
            if (departmentSelect) {
              departmentSelect.innerHTML =
                '<option value="">Tous les départements</option>';
              departments.forEach((department) => {
                departmentSelect.innerHTML += `<option value="${department}">${department}</option>`;
              });
            }
          }
        } catch (error) {
          console.error("Error loading filter options:", error);
        }
      }

      // Load news
      async function loadNews() {
        try {
          showNewsLoading();
          const token =
            localStorage.getItem("adminToken") ||
            sessionStorage.getItem("authToken");

          if (!token) {
            console.warn("No authentication token found");
            showNewsError("Non autorisé - veuillez vous reconnecter");
            return;
          }

          // Get filter values
          const category =
            document.getElementById("newsCategoryFilter")?.value || "";
          const priority =
            document.getElementById("newsPriorityFilter")?.value || "";
          const location =
            document.getElementById("newsLocationFilter")?.value || "";
          const department =
            document.getElementById("newsDepartmentFilter")?.value || "";

          // Build query params
          const params = new URLSearchParams();
          if (category) params.append("category", category);
          if (priority) params.append("priority", priority);
          if (location) params.append("location", location);
          if (department) params.append("department", department);

          const url = `/api/news${
            params.toString() ? "?" + params.toString() : ""
          }`;

          const response = await fetch(url, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.ok) {
            const news = await response.json();
            displayNews(news);
          } else {
            throw new Error("Erreur lors du chargement des actualités");
          }
        } catch (error) {
          console.error("Error loading news:", error);
          showNewsError("Erreur lors du chargement des actualités");
        }
      }

      // Display news
      function displayNews(newsList) {
        const tbody = document.getElementById("newsTableBody");
        if (!newsList || newsList.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="8" style="text-align: center; padding: 40px; color: #6c757d;">
                <i class="fas fa-newspaper" style="font-size: 48px; margin-bottom: 10px;"></i>
                <br>Aucune actualité trouvée
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = newsList
          .map(
            (news) => `
          <tr>
            <td>
              ${news.imageUrl ? `<img src="${news.imageUrl}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; margin-right: 8px;" />` : ''}
              ${news.title || 'Sans titre'}
            </td>
            <td>
              <span class="badge badge-info">${news.category || 'Non définie'}</span>
            </td>
            <td>
              <span class="badge ${getPriorityBadgeClass(news.priority)}">${
              news.priority || 'Normal'
            }</span>
            </td>
            <td>${news.targetLocation || "Toutes"}</td>
            <td>${news.targetDepartment || "Tous"}</td>
            <td>
              <span class="badge ${
                news.isActive === true ? "badge-success" : "badge-warning"
              }">
                ${news.isActive === true ? "Publié" : "Inactif"}
              </span>
            </td>
            <td>${news.authorName || "Système"}</td>
            <td>${formatDate(news.createdAt)}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="editNews('${
                news.id
              }')">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteNews('${
                news.id
              }')">
                <i class="fas fa-trash"></i>
              </button>
              ${
                news.isActive !== true
                  ? `<button class="btn btn-sm btn-success" onclick="publishNews('${news.id}')">
                   <i class="fas fa-paper-plane"></i>
                 </button>`
                  : `<button class="btn btn-sm btn-warning" onclick="archiveNews('${news.id}')">
                   <i class="fas fa-archive"></i>
                 </button>`
              }
            </td>
          </tr>
        `
          )
          .join("");
      }

      // Get priority badge class
      function getPriorityBadgeClass(priority) {
        switch (priority) {
          case "URGENT":
            return "badge-danger";
          case "HIGH":
            return "badge-warning";
          case "MEDIUM":
            return "badge-primary";
          case "LOW":
            return "badge-secondary";
          default:
            return "badge-secondary";
        }
      }

      // Show add news modal
      async function showAddNewsModal() {
        console.log("showAddNewsModal called");

        try {
          document.getElementById("newsModalTitle").textContent =
            "Ajouter une actualité";
          document.getElementById("newsForm").reset();
          document.getElementById("newsId").value = "";
          
          // Reset image upload area
          document.getElementById("newsImageUrl").value = "";
          document.getElementById("newsImageName").value = "";
          document.getElementById("imagePreviewArea").style.display = "none";
          document.getElementById("imageUploadArea").style.display = "block";

          // Show modal first
          const modalElement = document.getElementById("newsModal");
          console.log("Modal element found:", modalElement);

          const modal = new bootstrap.Modal(modalElement, {
            backdrop: true,
            keyboard: true,
            focus: true,
          });

          console.log("About to show modal");
          modal.show();
          console.log("Modal show() called");

          // Then configure it asynchronously
          setTimeout(() => {
            checkUserRoleAndConfigureNewsModal();
          }, 100);
        } catch (error) {
          console.error("Error in showAddNewsModal:", error);
        }
      }

      // Close news modal
      function closeNewsModal() {
        const modal = bootstrap.Modal.getInstance(
          document.getElementById("newsModal")
        );
        if (modal) {
          modal.hide();
        }
      }

      // Check user role and configure news modal
      async function checkUserRoleAndConfigureNewsModal() {
        try {
          const token =
            localStorage.getItem("adminToken") ||
            sessionStorage.getItem("authToken");

          if (!token) {
            console.warn("No authentication token found for user-info");
            return;
          }

          const response = await fetch("/api/auth/user-info", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.ok) {
            const userInfo = await response.json();
            const isSuperAdmin = userInfo.role === "SUPERADMIN";

            // Show/hide superadmin target fields in modal
            const superAdminTargetFields = document.getElementById(
              "superAdminTargetFields"
            );
            if (superAdminTargetFields) {
              superAdminTargetFields.style.display = isSuperAdmin
                ? "block"
                : "none";
            }

            // Load location and department options for superadmin
            if (isSuperAdmin) {
              await loadNewsModalOptions();
            }
          }
        } catch (error) {
          console.error("Error checking user role for news modal:", error);
        }
      }

      // Load options for news modal
      async function loadNewsModalOptions() {
        try {
          const token =
            localStorage.getItem("adminToken") ||
            sessionStorage.getItem("authToken");

          // Load locations
          const locationsResponse = await fetch("/api/admin/locations", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (locationsResponse.ok) {
            const locations = await locationsResponse.json();
            const locationSelect =
              document.getElementById("newsTargetLocation");
            if (locationSelect) {
              locationSelect.innerHTML =
                '<option value="">Sélectionner une location</option>';
              locations.forEach((location) => {
                locationSelect.innerHTML += `<option value="${location}">${location}</option>`;
              });
            }
          }

          // Load departments
          const departmentsResponse = await fetch("/api/admin/departments", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (departmentsResponse.ok) {
            const departments = await departmentsResponse.json();
            const departmentSelect = document.getElementById(
              "newsTargetDepartment"
            );
            if (departmentSelect) {
              departmentSelect.innerHTML =
                '<option value="">Sélectionner un département</option>';
              departments.forEach((department) => {
                departmentSelect.innerHTML += `<option value="${department}">${department}</option>`;
              });
            }
          }
        } catch (error) {
          console.error("Error loading news modal options:", error);
        }
      }

      // Edit news
      async function editNews(newsId) {
        try {
          const token = localStorage.getItem("adminToken");
          const response = await fetch(`/api/news/${newsId}`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.ok) {
            const news = await response.json();

            // Fill form
            document.getElementById("newsModalTitle").textContent =
              "Modifier l'actualité";
            document.getElementById("newsId").value = news.id;
            document.getElementById("newsTitle").value = news.title;
            document.getElementById("newsCategory").value = news.category;
            document.getElementById("newsPriority").value = news.priority;
            document.getElementById("newsTargetLocation").value =
              news.targetLocation || "";
            document.getElementById("newsTargetDepartment").value =
              news.targetDepartment || "";
            document.getElementById("newsSummary").value = news.summary;
            document.getElementById("newsContent").value = news.content;

            const modal = new bootstrap.Modal(
              document.getElementById("newsModal")
            );
            modal.show();
          } else {
            throw new Error("Erreur lors du chargement de l'actualité");
          }
        } catch (error) {
          console.error("Error editing news:", error);
          alert("Erreur lors du chargement de l'actualité");
        }
      }

      // Save news (create or update)
      async function saveNews() {
        try {
          const token = localStorage.getItem("adminToken");
          const newsId = document.getElementById("newsId").value;
          const isEdit = newsId !== "";

          const newsData = {
            title: document.getElementById("newsTitle").value,
            category: document.getElementById("newsCategory").value,
            priority: document.getElementById("newsPriority").value,
            targetLocation:
              document.getElementById("newsTargetLocation").value || null,
            targetDepartment:
              document.getElementById("newsTargetDepartment").value || null,
            summary: document.getElementById("newsSummary").value,
            content: document.getElementById("newsContent").value,
            imageUrl: document.getElementById("newsImageUrl").value || null,
            imageName: document.getElementById("newsImageName").value || null,
          };

          // Debug: vérifier que le titre est bien récupéré
          console.log("Titre récupéré:", newsData.title);
          console.log("Données complètes:", newsData);

          // Validation basique
          if (!newsData.title || newsData.title.trim() === "") {
            alert("Le titre est obligatoire !");
            return;
          }

          console.log("News data being sent:", newsData);

          const url = isEdit ? `/api/news/${newsId}` : "/api/news";
          const method = isEdit ? "PUT" : "POST";

          const response = await fetch(url, {
            method: method,
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(newsData),
          });

          if (response.ok) {
            // Hide modal properly
            const newsModal = document.getElementById('newsModal');
            const modal = bootstrap.Modal.getInstance(newsModal);
            if (modal) {
              modal.hide();
            } else {
              // If modal instance doesn't exist, hide manually
              newsModal.style.display = 'none';
              document.body.classList.remove('modal-open');
              const backdrops = document.querySelectorAll('.modal-backdrop');
              backdrops.forEach(backdrop => backdrop.remove());
            }
            
            loadNews();
            alert(
              isEdit
                ? "Actualité modifiée avec succès!"
                : "Actualité créée avec succès!"
            );
          } else {
            const error = await response.text();
            throw new Error(error);
          }
        } catch (error) {
          console.error("Error saving news:", error);
          alert("Erreur lors de la sauvegarde: " + error.message);
        }
      }

      // Delete news
      async function deleteNews(newsId) {
        if (!confirm("Êtes-vous sûr de vouloir supprimer cette actualité ?")) {
          return;
        }

        try {
          const token = localStorage.getItem("adminToken");
          const response = await fetch(`/api/news/${newsId}`, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.ok) {
            loadNews();
            alert("Actualité supprimée avec succès!");
          } else {
            throw new Error("Erreur lors de la suppression");
          }
        } catch (error) {
          console.error("Error deleting news:", error);
          alert("Erreur lors de la suppression: " + error.message);
        }
      }

      // Publish news
      async function publishNews(newsId) {
        try {
          const token = localStorage.getItem("adminToken");
          const response = await fetch(`/api/news/${newsId}/publish`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.ok) {
            loadNews();
            alert("Actualité publiée avec succès!");
          } else {
            throw new Error("Erreur lors de la publication");
          }
        } catch (error) {
          console.error("Error publishing news:", error);
          alert("Erreur lors de la publication: " + error.message);
        }
      }

      // Archive news
      async function archiveNews(newsId) {
        if (!confirm("Êtes-vous sûr de vouloir archiver cette actualité ?")) {
          return;
        }

        try {
          const token = localStorage.getItem("adminToken");
          const response = await fetch(`/api/news/${newsId}/archive`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.ok) {
            loadNews();
            alert("Actualité archivée avec succès!");
          } else {
            throw new Error("Erreur lors de l'archivage");
          }
        } catch (error) {
          console.error("Error archiving news:", error);
          alert("Erreur lors de l'archivage: " + error.message);
        }
      }

      // Show news loading
      function showNewsLoading() {
        document.getElementById("newsTableBody").innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center; padding: 40px;">
              <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #007bff;"></i>
              <br><span style="color: #666; margin-top: 10px;">Chargement des actualités...</span>
            </td>
          </tr>
        `;
      }

      // Image upload functions
      async function handleImageUpload() {
        const fileInput = document.getElementById('newsImageFile');
        const file = fileInput.files[0];
        
        if (!file) return;
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
          alert('Veuillez sélectionner une image valide');
          fileInput.value = '';
          return;
        }
        
        // Validate file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
          alert('La taille du fichier ne doit pas dépasser 5MB');
          fileInput.value = '';
          return;
        }
        
        try {
          // Show upload progress
          document.getElementById('imageUploadArea').style.display = 'none';
          document.getElementById('uploadProgress').style.display = 'block';
          
          const formData = new FormData();
          formData.append('file', file);
          
          const token = localStorage.getItem('adminToken');
          const response = await fetch('/api/news/upload-image', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`
            },
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            // Show image preview
            document.getElementById('newsImageUrl').value = result.imageUrl;
            document.getElementById('newsImageName').value = result.imageName;
            
            const preview = document.getElementById('imagePreview');
            preview.src = result.imageUrl;
            
            document.getElementById('imageInfo').textContent = `${result.imageName} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
            
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('imagePreviewArea').style.display = 'block';
          } else {
            throw new Error(result.message);
          }
        } catch (error) {
          console.error('Error uploading image:', error);
          alert('Erreur lors de l\'upload de l\'image: ' + error.message);
          
          // Reset upload area
          document.getElementById('uploadProgress').style.display = 'none';
          document.getElementById('imageUploadArea').style.display = 'block';
          fileInput.value = '';
        }
      }
      
      function removeImage() {
        document.getElementById('newsImageUrl').value = '';
        document.getElementById('newsImageName').value = '';
        document.getElementById('newsImageFile').value = '';
        
        document.getElementById('imagePreviewArea').style.display = 'none';
        document.getElementById('imageUploadArea').style.display = 'block';
      }
      
      // Show news loading
      function showNewsLoading() {
        document.getElementById("newsTableBody").innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center; padding: 40px;">
              <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Chargement...</span>
              </div>
              <br>Chargement des actualités...
            </td>
          </tr>
        `;
      }

      // Show news error
      function showNewsError(message) {
        document.getElementById("newsTableBody").innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center; padding: 40px; color: #dc3545;">
              <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 10px;"></i>
              <br>${message}
            </td>
          </tr>
        `;
      }

      // Global sync data function
      async function syncData() {
        try {
          const syncBtn = document.querySelector(".sync-btn");
          const originalText = syncBtn.innerHTML;

          // Show loading state
          syncBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Syncing...';
          syncBtn.disabled = true;

          const response = await fetch("/api/admin/sync", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          if (response.ok) {
            const result = await response.json();
            showMessage(result.message || "Data synchronized successfully");

            // Reload data
            loadEmployees();
          } else {
            const error = await response.json();
            showMessage(error.error || "Failed to sync data");
          }
        } catch (error) {
          showMessage("Error syncing data: " + error.message);
        } finally {
          // Restore button state
          const syncBtn = document.querySelector(".sync-btn");
          syncBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Sync Data';
          syncBtn.disabled = false;
        }
      }

      // Show error message
      function showError(message) {
        const messageDiv = document.createElement("div");
        messageDiv.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #dc3545;
          color: white;
          padding: 12px 20px;
          border-radius: 4px;
          z-index: 1000;
          box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        `;
        messageDiv.textContent = message;
        document.body.appendChild(messageDiv);

        setTimeout(() => {
          if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
          }
        }, 3000);
      }

      // Show success message
      function showMessage(message) {
        const messageDiv = document.createElement("div");
        messageDiv.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #28a745;
          color: white;
          padding: 12px 20px;
          border-radius: 4px;
          z-index: 1000;
          box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        `;
        messageDiv.textContent = message;
        document.body.appendChild(messageDiv);

        setTimeout(() => {
          if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
          }
        }, 3000);
      }

      // Navigation handling
      document.addEventListener("DOMContentLoaded", function () {
        // Check authentication first, which will then load employees
        checkAuthentication();

        // Show employee table by default
        document.getElementById("employeeTable").style.display = "block";
        document.getElementById("welcomeMessage").style.display = "none";
        document.getElementById("mainTitle").textContent = "LEOIN Management";
        document.getElementById("sectionTitle").textContent =
          "Employee Management";
        document.getElementById("addEmployeeBtn").style.display = "inline-flex";

        // Handle navigation clicks
        document
          .getElementById("employeesLink")
          .addEventListener("click", function (e) {
            e.preventDefault();

            // Update active navigation
            document
              .querySelectorAll(".nav-menu a")
              .forEach((link) => link.classList.remove("active"));
            this.classList.add("active");

            // Show employee table
            document.getElementById("mainContentSection").style.display =
              "block";
            document.getElementById("employeeTable").style.display = "block";
            document.getElementById("pendingRequestsSection").style.display =
              "none";
            document.getElementById("documentTypesSection").style.display =
              "none";
            document.getElementById("newsSection").style.display = "none";
            document.getElementById("adminsSection").style.display = "none";
            document.getElementById("welcomeMessage").style.display = "none";
            document.getElementById("sectionTitle").textContent =
              "Employee Management";
            document.getElementById("addEmployeeBtn").style.display =
              "inline-flex";

            // Load fresh data
            loadEmployees();
          });

        // Handle admins navigation (SuperAdmin only)
        const adminsLink = document.getElementById("adminsLink");
        if (adminsLink) {
          adminsLink.addEventListener("click", function (e) {
            e.preventDefault();

            // Update active navigation
            document
              .querySelectorAll(".nav-menu a")
              .forEach((link) => link.classList.remove("active"));
            this.classList.add("active");

            // Show admins section
            document.getElementById("mainContentSection").style.display = "none";
            document.getElementById("employeeTable").style.display = "none";
            document.getElementById("pendingRequestsSection").style.display = "none";
            document.getElementById("documentTypesSection").style.display = "none";
            document.getElementById("newsSection").style.display = "none";
            document.getElementById("adminsSection").style.display = "block";
            document.getElementById("welcomeMessage").style.display = "none";
            document.getElementById("addEmployeeBtn").style.display = "none";

            // Load admins
            loadAdmins();
          });
        }

        // Handle pending requests navigation
        document
          .getElementById("pendingRequestsLink")
          .addEventListener("click", function (e) {
            e.preventDefault();

            // Update active navigation
            document
              .querySelectorAll(".nav-menu a")
              .forEach((link) => link.classList.remove("active"));
            this.classList.add("active");

            // Hide employee section and show pending requests
            document.getElementById("mainContentSection").style.display =
              "none";
            document.getElementById("employeeTable").style.display = "none";
            document.getElementById("pendingRequestsSection").style.display =
              "block";
            document.getElementById("documentTypesSection").style.display =
              "none";
            document.getElementById("welcomeMessage").style.display = "none";
            document.getElementById("addEmployeeBtn").style.display = "none";

            // Load pending requests
            loadPendingRequests();
          });

        // Handle document types navigation
        document
          .getElementById("documentTypesLink")
          .addEventListener("click", function (e) {
            e.preventDefault();

            // Update active navigation
            document
              .querySelectorAll(".nav-menu a")
              .forEach((link) => link.classList.remove("active"));
            this.classList.add("active");

            // Hide other sections and show document types
            document.getElementById("mainContentSection").style.display =
              "none";
            document.getElementById("employeeTable").style.display = "none";
            document.getElementById("pendingRequestsSection").style.display =
              "none";
            document.getElementById("documentTypesSection").style.display =
              "block";
            document.getElementById("newsSection").style.display = "none";
            document.getElementById("welcomeMessage").style.display = "none";
            document.getElementById("addEmployeeBtn").style.display = "none";

            // Load document types
            loadDocumentTypes();
          });

        // Handle news navigation
        document
          .getElementById("newsLink")
          .addEventListener("click", function (e) {
            e.preventDefault();

            // Update active navigation
            document
              .querySelectorAll(".nav-menu a")
              .forEach((link) => link.classList.remove("active"));
            this.classList.add("active");

            // Hide other sections and show news
            document.getElementById("mainContentSection").style.display =
              "none";
            document.getElementById("employeeTable").style.display = "none";
            document.getElementById("pendingRequestsSection").style.display =
              "none";
            document.getElementById("documentTypesSection").style.display =
              "none";
            document.getElementById("newsSection").style.display = "block";
            document.getElementById("welcomeMessage").style.display = "none";
            document.getElementById("addEmployeeBtn").style.display = "none";

            // Check user role and configure news section
            checkUserRoleAndConfigureNewsSection();
            loadNewsFilterOptions(); // Load filter options
            loadNews();
          });

        // Document type form submission
        document
          .getElementById("documentTypeForm")
          .addEventListener("submit", async function (e) {
            e.preventDefault();

            const formData = {
              name: document.getElementById("documentTypeName").value,
              description: document.getElementById("documentTypeDescription")
                .value,
              active: document.getElementById("documentTypeActive").checked,
            };

            try {
              const isEdit = currentDocumentType !== null;
              const url = isEdit
                ? `/api/admin/document-types/${currentDocumentType.id}`
                : "/api/admin/document-types";
              const method = isEdit ? "PUT" : "POST";

              const response = await fetch(url, {
                method: method,
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(formData),
              });

              if (response.ok) {
                showMessage(
                  `Document type ${isEdit ? "updated" : "created"} successfully`
                );
                closeDocumentTypeModal();
                loadDocumentTypes();
              } else {
                const error = await response.text();
                showError(
                  `Failed to ${isEdit ? "update" : "create"} document type: ` +
                    error
                );
              }
            } catch (error) {
              showError(
                `Error ${
                  currentDocumentType ? "updating" : "creating"
                } document type: ` + error.message
              );
            }
          });

        // Close modal when clicking outside
        window.onclick = function (event) {
          const employeeModal = document.getElementById("employeeModal");
          const documentTypeModal =
            document.getElementById("documentTypeModal");
          const newsModal = document.getElementById("newsModal");
          if (event.target === employeeModal) {
            closeModal();
          }
          if (event.target === documentTypeModal) {
            closeDocumentTypeModal();
          }
          if (event.target === newsModal) {
            const modal = bootstrap.Modal.getInstance(newsModal);
            if (modal) modal.hide();
          }
        };

        // News form submission
        document
          .getElementById("newsForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            saveNews();
          });

        // News filter event listeners
        const newsFilters = [
          "newsCategoryFilter",
          "newsPriorityFilter",
          "newsLocationFilter",
          "newsDepartmentFilter",
        ];
        newsFilters.forEach((filterId) => {
          const filterElement = document.getElementById(filterId);
          if (filterElement) {
            filterElement.addEventListener("change", loadNews);
          }
        });

        // Add news button
        const addNewsBtn = document.getElementById("addNewsBtn");
        if (addNewsBtn) {
          addNewsBtn.addEventListener("click", showAddNewsModal);
        }
      });

      // ==================== NAVIGATION FUNCTIONS ====================

      // Show admins section (SuperAdmin only)
      function showAdminsSection() {
        console.log("showAdminsSection called");
        
        // Update active navigation
        document.querySelectorAll(".nav-menu a").forEach((link) => link.classList.remove("active"));
        const adminLink = document.querySelector('a[onclick="showAdminsSection()"]');
        if (adminLink) {
          adminLink.classList.add("active");
        }

        // Hide all other sections
        document.getElementById("mainContentSection").style.display = "none";
        document.getElementById("employeeTable").style.display = "none";
        document.getElementById("pendingRequestsSection").style.display = "none";
        document.getElementById("documentTypesSection").style.display = "none";
        document.getElementById("newsSection").style.display = "none";
        document.getElementById("welcomeMessage").style.display = "none";
        document.getElementById("addEmployeeBtn").style.display = "none";
        
        // Show admins section
        document.getElementById("adminsSection").style.display = "block";

        // Load admins data
        loadAdmins();
      }

      // ==================== ADMINS MANAGEMENT FUNCTIONS (SuperAdmin only) ====================
      
      let admins = [];

      // Load all admins (SuperAdmin only)
      async function loadAdmins() {
        try {
          showAdminsLoading();
          
          const userRole = sessionStorage.getItem("userRole");
          if (userRole !== "SUPERADMIN") {
            showAdminsError("Access denied: SuperAdmin role required");
            return;
          }

          console.log("Loading all admins for SuperAdmin");
          const response = await fetch("/api/superadmin/admins");
          
          if (response.ok) {
            admins = await response.json();
            console.log("SuperAdmin loaded", admins.length, "admins");
            displayAdmins();
          } else {
            showAdminsError("Failed to load admins");
          }
        } catch (error) {
          showAdminsError("Error loading admins: " + error.message);
        }
      }

      // Display admins in table
      function displayAdmins() {
        const tbody = document.getElementById("adminsTableBody");

        if (admins.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="9" style="text-align: center; padding: 40px; color: #666;">
                <i class="fas fa-user-shield" style="font-size: 48px; margin-bottom: 10px; opacity: 0.3;"></i>
                <br>Aucun admin trouvé.
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = admins
          .map(admin => `
            <tr>
              <td>${admin.username}</td>
              <td>${admin.firstName || 'N/A'}</td>
              <td>${admin.lastName || 'N/A'}</td>
              <td>${admin.email || 'N/A'}</td>
              <td>${admin.department || 'N/A'}</td>
              <td>${admin.location || 'N/A'}</td>
              <td>
                <span class="badge ${admin.active ? 'badge-success' : 'badge-danger'}">
                  ${admin.active ? 'Actif' : 'Inactif'}
                </span>
              </td>
              <td>${admin.lastLogin ? formatDateSafe(admin.lastLogin) : 'Jamais'}</td>
              <td>
                <div class="action-buttons">
                  <button class="btn-action btn-view" onclick="viewAdmin('${admin.id}')">
                    <i class="fas fa-eye"></i> Voir
                  </button>
                  <button class="btn-action btn-edit" onclick="editAdmin('${admin.id}')">
                    <i class="fas fa-edit"></i> Modifier
                  </button>
                  <button class="btn-action ${admin.active ? 'btn-warning' : 'btn-success'}" 
                          onclick="toggleAdminStatus('${admin.id}', ${admin.active})">
                    <i class="fas fa-${admin.active ? 'pause' : 'play'}"></i> 
                    ${admin.active ? 'Désactiver' : 'Activer'}
                  </button>
                </div>
              </td>
            </tr>
          `)
          .join("");
      }

      // Toggle admin status
      async function toggleAdminStatus(adminId, currentStatus) {
        const action = currentStatus ? 'désactiver' : 'activer';
        if (!confirm(`Êtes-vous sûr de vouloir ${action} cet admin ?`)) {
          return;
        }

        try {
          const response = await fetch(`/api/admin/${adminId}/toggle-status`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            }
          });

          if (response.ok) {
            alert(`Admin ${action} avec succès !`);
            loadAdmins(); // Reload admins
          } else {
            alert(`Erreur lors de la ${action} de l'admin`);
          }
        } catch (error) {
          alert(`Erreur: ${error.message}`);
        }
      }

      // View admin details
      function viewAdmin(adminId) {
        const admin = admins.find(a => a.id === adminId);
        if (admin) {
          alert(`Détails de l'admin: ${JSON.stringify(admin, null, 2)}`);
        }
      }

      // Edit admin (placeholder)
      function editAdmin(adminId) {
        alert("Fonctionnalité de modification des admins à implémenter");
      }

      // Show add admin modal (placeholder)
      function showAddAdminModal() {
        alert("Fonctionnalité d'ajout d'admin à implémenter");
      }

      // Load admin statistics
      async function loadAdminsStats() {
        try {
          const response = await fetch("/api/superadmin/stats");
          if (response.ok) {
            const stats = await response.json();
            alert(`Statistiques:\n- Total Admins: ${stats.totalAdmins}\n- Admins Actifs: ${stats.activeAdmins}\n- Total Employés: ${stats.totalEmployees}\n- Total Actualités: ${stats.totalNews}`);
          } else {
            alert("Erreur lors du chargement des statistiques");
          }
        } catch (error) {
          alert("Erreur: " + error.message);
        }
      }

      // Show loading state for admins
      function showAdminsLoading() {
        document.getElementById("adminsTableBody").innerHTML = `
          <tr>
            <td colspan="9" style="text-align: center; padding: 40px; color: #666;">
              <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
              <br>Chargement des admins...
            </td>
          </tr>
        `;
      }

      // Show error message for admins
      function showAdminsError(message) {
        document.getElementById("adminsTableBody").innerHTML = `
          <tr>
            <td colspan="9" style="text-align: center; padding: 40px; color: #dc3545;">
              <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
              <br>${message}
            </td>
          </tr>
        `;
      }

      // ==================== FILTER FUNCTIONS ====================

      let originalEmployees = []; // Store original employee data for filtering
      let originalNews = []; // Store original news data for filtering

      // Load filter options for employees
      async function loadEmployeeFilterOptions() {
        try {
          const token = localStorage.getItem("adminToken") || sessionStorage.getItem("authToken");
          
          // Load departments
          const departmentsResponse = await fetch("/api/users/departments", {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (departmentsResponse.ok) {
            const departments = await departmentsResponse.json();
            const departmentSelect = document.getElementById("employeeDepartmentFilter");
            if (departmentSelect) {
              departmentSelect.innerHTML = '<option value="">Tous les départements</option>';
              departments.forEach((department) => {
                departmentSelect.innerHTML += `<option value="${department}">${department}</option>`;
              });
            }
          }

          // Load locations
          const locationsResponse = await fetch("/api/users/locations", {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (locationsResponse.ok) {
            const locations = await locationsResponse.json();
            const locationSelect = document.getElementById("employeeLocationFilter");
            if (locationSelect) {
              locationSelect.innerHTML = '<option value="">Toutes les locations</option>';
              locations.forEach((location) => {
                locationSelect.innerHTML += `<option value="${location}">${location}</option>`;
              });
            }
          }

          // Load positions from employees
          if (employees.length > 0) {
            const positions = [...new Set(employees.map(emp => emp.position).filter(pos => pos))];
            const positionSelect = document.getElementById("employeePositionFilter");
            if (positionSelect) {
              positionSelect.innerHTML = '<option value="">Toutes les positions</option>';
              positions.forEach((position) => {
                positionSelect.innerHTML += `<option value="${position}">${position}</option>`;
              });
            }
          }
        } catch (error) {
          console.error("Error loading employee filter options:", error);
        }
      }

      // Apply employee filters
      function applyEmployeeFilters() {
        console.log("🔍 applyEmployeeFilters called");
        const departmentFilter = document.getElementById("employeeDepartmentFilter").value;
        const locationFilter = document.getElementById("employeeLocationFilter").value;
        const positionFilter = document.getElementById("employeePositionFilter").value;

        console.log("🔍 Filter values:", { departmentFilter, locationFilter, positionFilter });
        console.log("🔍 Original employees count:", originalEmployees.length);
        console.log("🔍 Current employees count:", employees.length);

        let filteredEmployees = originalEmployees.length > 0 ? originalEmployees : employees;
        console.log("🔍 Starting with employees count:", filteredEmployees.length);

        if (departmentFilter) {
          filteredEmployees = filteredEmployees.filter(emp => emp.department === departmentFilter);
          console.log("🔍 After department filter:", filteredEmployees.length);
        }
        if (locationFilter) {
          filteredEmployees = filteredEmployees.filter(emp => emp.location === locationFilter);
          console.log("🔍 After location filter:", filteredEmployees.length);
        }
        if (positionFilter) {
          filteredEmployees = filteredEmployees.filter(emp => emp.position === positionFilter);
          console.log("🔍 After position filter:", filteredEmployees.length);
        }

        // Update the global employees array for display
        employees = filteredEmployees;
        console.log("🔍 Final filtered employees count:", employees.length);
        displayEmployees();
      }

      // Clear employee filters
      function clearEmployeeFilters() {
        document.getElementById("employeeDepartmentFilter").value = "";
        document.getElementById("employeeLocationFilter").value = "";
        document.getElementById("employeePositionFilter").value = "";
        
        // Restore original employees
        if (originalEmployees.length > 0) {
          employees = [...originalEmployees];
          displayEmployees();
        }
      }

      // Apply news filters
      async function applyNewsFilters() {
        try {
          console.log("📰 applyNewsFilters called");
          const location = document.getElementById("filterLocation").value;
          const department = document.getElementById("filterDepartment").value;

          console.log("📰 Applying news filters:", { location, department });

          // Build query parameters - only location and department
          const params = new URLSearchParams();
          if (location) params.append("location", location);
          if (department) params.append("department", department);

          console.log("📰 Query string:", params.toString());

          const token = localStorage.getItem("adminToken") || sessionStorage.getItem("authToken");
          console.log("📰 Using token:", token ? "Present" : "Missing");
          
          const url = `/api/news?${params.toString()}`;
          console.log("📰 Fetching URL:", url);
          
          const response = await fetch(url, {
            headers: { Authorization: `Bearer ${token}` },
          });

          console.log("📰 Response status:", response.status);

          if (response.ok) {
            const filteredNews = await response.json();
            console.log("📰 Filtered news count:", filteredNews.length);
            displayNews(filteredNews);
          } else {
            console.error("📰 Failed to apply news filters, status:", response.status);
          }
        } catch (error) {
          console.error("📰 Error applying news filters:", error);
        }
      }

      // Load news filter options
      async function loadNewsFilterOptions() {
        try {
          const token = localStorage.getItem("adminToken") || sessionStorage.getItem("authToken");

          // Load locations
          const locationsResponse = await fetch("/api/users/locations", {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (locationsResponse.ok) {
            const locations = await locationsResponse.json();
            const locationSelect = document.getElementById("filterLocation");
            if (locationSelect) {
              locationSelect.innerHTML = '<option value="">Toutes les locations</option>';
              locations.forEach((location) => {
                locationSelect.innerHTML += `<option value="${location}">${location}</option>`;
              });
            }
          }

          // Load departments
          const departmentsResponse = await fetch("/api/users/departments", {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (departmentsResponse.ok) {
            const departments = await departmentsResponse.json();
            const departmentSelect = document.getElementById("filterDepartment");
            if (departmentSelect) {
              departmentSelect.innerHTML = '<option value="">Tous les départements</option>';
              departments.forEach((department) => {
                departmentSelect.innerHTML += `<option value="${department}">${department}</option>`;
              });
            }
          }
        } catch (error) {
          console.error("Error loading news filter options:", error);
        }
      }

      // Logout function - moved outside DOMContentLoaded to be globally accessible
      function logout() {
        // Clear session storage
        sessionStorage.removeItem("currentAdmin");
        sessionStorage.removeItem("authToken");
        sessionStorage.removeItem("userRole");
        // Clear local storage as well
        localStorage.removeItem("adminToken");
        // Redirect to main page
        window.location.href = "/";
      }
    </script>
  </body>
</html>
